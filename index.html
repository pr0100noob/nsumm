<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; connect-src *;">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>nsumm.ru</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  #carousel-track { display:flex; transition:transform 0.35s cubic-bezier(.4,0,.2,1); will-change:transform; }
  .carousel-card  { min-width:100%; box-sizing:border-box; }
  #carousel-wrap  { touch-action:pan-y; user-select:none; cursor:grab; }
  #carousel-wrap:active { cursor:grabbing; }
  .progress-bar   { transition: width 0.4s ease; }
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">

<div class="text-center mb-10">
  <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">nsumm.ru</h1>
  <p class="text-xl text-gray-600">–ò–ò-—Å–∞–º–º–∞—Ä–∏ –Ω–æ–≤–æ—Å—Ç–µ–π ‚Äî Router AI</p>
</div>

<!-- –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<div class="max-w-xl mx-auto mb-8 bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
  <p class="font-bold text-gray-800 mb-1">Router AI</p>
  <p class="text-xs text-gray-400 mb-3">–û–±–ª–∞—á–Ω–∞—è –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ routerai.ru</p>
  <div class="flex gap-2 items-center">
    <select id="routerModel" onchange="saveModel()"
      class="flex-1 border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-blue-400">
      <option value="google/gemma-3-4b-it">google/gemma-3-4b-it</option>
    </select>
    <button onclick="testRouter()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-2 rounded-xl text-sm">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
  </div>
  <div id="routerStatus" class="mt-3 text-sm hidden"></div>
</div>

<!-- –û–ü–¶–ò–Ø 1: –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
<!--
<div class="flex flex-wrap gap-4 justify-center mb-6">
  <button onclick="loadNews('tech')"     class="px-8 py-3 bg-blue-500   hover:bg-blue-600   text-white font-bold rounded-2xl shadow-lg text-lg transition-all hover:scale-105">IT</button>
  <button onclick="loadNews('politics')" class="px-8 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-2xl shadow-lg text-lg transition-all hover:scale-105">–ü–æ–ª–∏—Ç–∏–∫–∞</button>
  <button onclick="loadNews('sport')"    class="px-8 py-3 bg-orange-500  hover:bg-orange-600  text-white font-bold rounded-2xl shadow-lg text-lg transition-all hover:scale-105">–°–ø–æ—Ä—Ç</button>
  <button onclick="loadNews('world')"    class="px-8 py-3 bg-purple-500  hover:bg-purple-600  text-white font-bold rounded-2xl shadow-lg text-lg transition-all hover:scale-105">–ú–∏—Ä</button>
</div>
-->

<!-- –î–æ–±–∞–≤–∏–º –∏–Ω—Ñ–æ-–±–ª–æ–∫ –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
<div class="max-w-xl mx-auto mb-6 text-center text-gray-600 bg-white rounded-2xl shadow-lg p-4">
  <p class="font-medium">–ù–æ–≤–æ—Å—Ç–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç.</p>
</div>

<!-- –°–µ–∫—Ü–∏—è "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞ –¥–∞—Ç—É" –æ—Å—Ç–∞–ª–∞—Å—å, –Ω–æ –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -->
<div class="max-w-xl mx-auto mb-8 bg-white rounded-2xl shadow-lg p-5 border border-indigo-100">
  <p class="font-bold text-gray-800 mb-1">üìÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –∑–∞ –¥–∞—Ç—É</p>
  <p class="text-xs text-gray-400 mb-3">–í—Å–µ —Ç–µ–º—ã + –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
  <div class="flex gap-2 items-center">
    <input id="datePicker" type="date" class="flex-1 border border-gray-300 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-indigo-400" />
    <button onclick="loadByDate()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold px-5 py-2 rounded-xl text-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <button onclick="stopLoading()" id="stopBtn" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-xl text-sm">–°—Ç–æ–ø</button>
  </div>
  <div id="progressWrap" class="mt-3 hidden">
    <div class="flex justify-between text-xs text-gray-500 mb-1">
      <span id="progressLabel"></span>
      <span id="progressCount"></span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2">
      <div id="progressBar" class="progress-bar bg-indigo-500 h-2 rounded-full" style="width:0%"></div>
    </div>
  </div>
</div>

<!-- –õ–æ–≥ –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<div class="max-w-6xl mx-auto mb-6 bg-gray-900 rounded-xl p-4">
  <div class="flex justify-between items-center mb-2">
    <div class="flex items-center gap-3">
      <span class="text-green-400 font-mono text-sm font-bold">LOG</span>
      <span id="globalPollStatus" class="text-xs text-emerald-400 hidden"></span>
    </div>
    <div class="flex gap-2">
      <button onclick="clearArchive()" class="text-red-400 text-xs px-2 py-1 bg-gray-700 rounded hover:bg-gray-600">–û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤</button>
      <button onclick="document.getElementById('log').innerHTML=''" class="text-gray-400 text-xs px-2 py-1 bg-gray-700 rounded hover:bg-gray-600">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>
  </div>
  <div id="log" class="font-mono text-xs space-y-1 max-h-48 overflow-y-auto"></div>
</div>

<!-- –ö–∞—Ä—É—Å–µ–ª—å –æ—Å—Ç–∞–ª–∞—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<div class="max-w-2xl mx-auto mb-4 relative px-8">
  <div class="flex justify-between items-center mb-3">
    <span id="carousel-counter" class="text-sm text-gray-500 font-medium"></span>
    <span id="carousel-status" class="text-xs text-purple-600 font-semibold hidden"></span>
  </div>
  <div id="carousel-wrap" class="overflow-hidden rounded-2xl shadow-xl bg-white border border-gray-100">
    <div id="carousel-track"></div>
  </div>
  <button onclick="carouselPrev()" class="absolute left-0 top-1/2 -translate-y-6 bg-white shadow-lg rounded-full w-10 h-10 flex items-center justify-center text-gray-500 hover:text-blue-600 text-xl font-bold z-10 border border-gray-100">‚Äπ</button>
  <button onclick="carouselNext()" class="absolute right-0 top-1/2 -translate-y-6 bg-white shadow-lg rounded-full w-10 h-10 flex items-center justify-center text-gray-500 hover:text-blue-600 text-xl font-bold z-10 border border-gray-100">‚Ä∫</button>
  <div id="carousel-dots" class="flex justify-center gap-2 mt-4 flex-wrap"></div>
</div>

<div id="errorMsg" class="hidden text-center text-red-500 py-6 text-lg font-medium"></div>

<script>
// --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
var FEEDS = {
  tech: [
    "https://habr.com/ru/rss/news/",
    "https://rssexport.rbc.ru/rbcnews/news/30/full.rss"
  ],
  politics: [
    "https://www.kommersant.ru/RSS/news.xml",
    "https://ria.ru/export/rss2/politics/index.xml"
  ],
  sport: [
    "https://sports.ru/rss/news/",
    "https://ria.ru/export/rss2/sport/index.xml",
    "https://www.sovsport.ru/rss"
  ],
  world: [
    "https://tass.ru/rss/v2.xml",
    "https://ria.ru/export/rss2/world/index.xml"
  ]
};

var PROXIES = [
  "/api/rss?url=",
  "https://corsproxy.io/?",
  "https://api.codetabs.com/v1/proxy?quest=",
  "https://thingproxy.freeboard.io/fetch/",
  "https://api.allorigins.win/raw?url="
];

var ALL_CATS             = ["tech","politics","sport","world"];
var ARCHIVE_KEY          = "nsumm_archive";
var ARCHIVE_MAX          = 500;
// –£–º–µ–Ω—å—à–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 10 –º–∏–Ω—É—Ç (600000 –º—Å)
var GLOBAL_POLL_INTERVAL = 10 * 60 * 1000; 

var ROUTER_KEY   = "sk-ieuhiOOQYAWSigF7yz94GcMsxabDbUPp";
var ROUTER_URL   = "https://routerai.ru/api/v1/chat/completions";

var _cat             = "all";
var _fi              = 0;
var _pi              = 0;
var _globalPollTimer = null;
var _aiRunning       = false;
var _stopFlag        = false;
var _globalPollBusy  = false;

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
function getTodaysDate() {
  var d = new Date();
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—ã
(function () {
  document.getElementById("datePicker").value = getTodaysDate();
})();

// --- –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
function getModel() { return document.getElementById("routerModel").value; }
// ... [–§—É–Ω–∫—Ü–∏–∏ log, setStatus, setGlobalStatus, setProgress, saveModel, restoreSettings –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ...

// --- –ê–†–•–ò–í ---
// ... [–§—É–Ω–∫—Ü–∏–∏ archiveLoadAll, archiveSaveAll, archiveGetCat, archiveAdd –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ...
function clearArchive() {
  if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∞—Ä—Ö–∏–≤?")) return;
  localStorage.removeItem(ARCHIVE_KEY);
  _carousel.items = []; renderCarousel();
  log("Archive cleared", "ok");
}

// --- –ö–ê–†–£–°–ï–õ–¨ ---
// ... [–í–µ—Å—å –±–ª–æ–∫ –∫–æ–¥–∞ –∫–∞—Ä—É—Å–µ–ª–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ...

// --- ROUTER AI ---
// ... [–§—É–Ω–∫—Ü–∏–∏ testRouter, buildPrompt, runAI –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ...

// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –ê–†–•–ò–í–ê –ó–ê –°–ï–ì–û–î–ù–Ø ---
function loadTodayArchive() {
  var today = getTodaysDate();
  log("=== Loading archive for: " + today + " ===", "info");
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞
  var allNews = [];
  ALL_CATS.forEach(function(cat) {
    var catNews = archiveGetCat(cat);
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
    catNews.forEach(function(item) {
      if (item.date && item.date.startsWith(today)) {
        allNews.push(item);
      }
    });
  });

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
  allNews.sort(function(a, b) {
    return new Date(b.date) - new Date(a.date);
  });

  _carousel.items = allNews;
  _carousel.idx = 0;
  renderCarousel();
  log("Loaded " + allNews.length + " items from today's archive", "ok");
}

// --- RSS --- (–§—É–Ω–∫—Ü–∏—è loadNews —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –Ω—É–∂–¥)
function loadNews(cat) {
  // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  _cat = cat; _fi = 0; _pi = 0;
  document.getElementById("errorMsg").classList.add("hidden");
  log("=== Manual load: " + cat + " ===", "info");
  var archived = archiveGetCat(cat);
  _carousel.items = archived.slice(); _carousel.idx = 0; renderCarousel();
  if (archived.length) log("Archive: " + archived.length, "ok");
  setStatus("loading RSS...");
  tryProxy();
}

function tryProxy() {
  // ... [–û—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ...
}

// --- –ì–õ–û–ë–ê–õ–¨–ù–´–ô –û–ü–†–û–° –° –§–ò–õ–¨–¢–†–ê–¶–ò–ï–ô –ü–û –î–ê–¢–ï ---
function startGlobalPolling() {
  if (_globalPollTimer) clearInterval(_globalPollTimer);
  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥, –∑–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  setTimeout(function () { globalPollCycle(); }, 30000);
  _globalPollTimer = setInterval(function () { globalPollCycle(); }, GLOBAL_POLL_INTERVAL);
  log("Global poll: all cats every 10 min", "info");
}

function globalPollCycle() {
  if (_globalPollBusy) { log("Global poll: busy, skip", "warn"); return; }
  _globalPollBusy = true;
  var today = getTodaysDate();
  log("Global poll: starting cycle for " + today + "...", "info");
  setGlobalStatus("üïë global scan for " + today + "...");
  var catIdx = 0;
  function nextCat() {
    if (catIdx >= ALL_CATS.length) {
      _globalPollBusy = false; setGlobalStatus("");
      log("Global poll: cycle done", "ok");
      // –ü–æ—Å–ª–µ –æ–ø—Ä–æ—Å–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—É—Å–µ–ª—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
      loadTodayArchive();
      return;
    }
    var cat = ALL_CATS[catIdx];
    setGlobalStatus("üïë scanning " + cat + " for " + today + "...");
    globalPollCat(cat, today, function () { catIdx++; nextCat(); });
  }
  nextCat();
}

// –ò–∑–º–µ–Ω–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞: –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `targetDate`
function globalPollCat(cat, targetDate, onCatDone) {
  var feeds = FEEDS[cat], fi = 0;
  function nextFeed() {
    if (fi >= feeds.length) { onCatDone(); return; }
    var pi = 0;
    function tryP() {
      if (pi >= PROXIES.length) { fi++; nextFeed(); return; }
      var xhr = new XMLHttpRequest();
      xhr.open("GET", PROXIES[pi] + encodeURIComponent(feeds[fi]), true); xhr.timeout = 12000;
      xhr.onload = function () {
        if (xhr.status !== 200 || xhr.responseText.length < 500
          || (xhr.responseText.indexOf("<item") < 0 && xhr.responseText.indexOf("<entry") < 0)) { pi++; tryP(); return; }
        // –ü–µ—Ä–µ–¥–∞–µ–º targetDate –≤ parseFeed
        parseFeed(xhr.responseText, cat, 20, targetDate, function (added) {
          log("Global [" + cat + "] feed " + (fi + 1) + "/" + feeds.length + ": +" + added, "ok");
          fi++; nextFeed();
        });
      };
      xhr.ontimeout = xhr.onerror = function () { pi++; tryP(); };
      xhr.send();
    }
    tryP();
  }
  nextFeed();
}

// --- LOAD BY DATE --- (–û—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
function stopLoading() { /* ... */ }
function loadByDate() { /* ... */ }

// --- PARSE FEED --- (–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å targetDate)
function parseFeed(xml, cat, limit, targetDate, onDone) {
  var doc = new DOMParser().parseFromString(xml, "text/xml");
  var items = doc.querySelectorAll("item");
  if (!items.length) items = doc.querySelectorAll("entry");
  var arts = [], n = 0;
  items.forEach(function (it) {
    if (n >= limit) return;
    var title = it.querySelector("title") ? it.querySelector("title").textContent.trim() : "";
    var lel   = it.querySelector("link");
    var link  = lel ? (lel.textContent.trim() || lel.getAttribute("href") || "#") : "#";
    var del   = it.querySelector("description") || it.querySelector("summary") || it.querySelector("content");
    var desc  = "";
    if (del) { var tmp = document.createElement("div"); tmp.innerHTML = del.textContent; desc = (tmp.innerText || tmp.textContent || "").replace(/\s+/g, " ").trim(); }
    if (desc.length < title.length + 20) desc = "";
    var pubRaw = it.querySelector("pubDate") ? it.querySelector("pubDate").textContent.trim() : "";
    var date   = pubRaw.slice(0, 16);

    // --- –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ targetDate ---
    // –ï—Å–ª–∏ targetDate –∑–∞–¥–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ globalPoll), —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –Ω–µ–º—É.
    // –ï—Å–ª–∏ targetDate –Ω–µ –∑–∞–¥–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å–µ.
    if (targetDate) {
      if (!pubRaw) return;
      var dd = new Date(pubRaw);
      var ds = dd.getFullYear() + "-" + String(dd.getMonth() + 1).padStart(2, "0") + "-" + String(dd.getDate()).padStart(2, "0");
      if (ds !== targetDate) return;
    }
    // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

    if (title) { arts.push({ title: title, link: link, desc: desc, date: date, cat: cat }); n++; }
  });

  var archivedLinks = archiveGetCat(cat).map(function (x) { return x.link; });
  var newArts = arts.filter(function (a) { return archivedLinks.indexOf(a.link) === -1; });
  if (!newArts.length) { if (onDone) onDone(0); return; }

  // –í –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–∞—Ä—É—Å–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞, –∞ –Ω–µ –∑–¥–µ—Å—å
  // if (cat === _cat) { /* ... —ç—Ç–∞ –ª–æ–≥–∏–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞ ... */ }

  var fetched = 0;
  newArts.forEach(function (a) {
    fetchArticleText(a.link, function (text) {
      a.fetchedText = text; fetched++;
      if (fetched === newArts.length) runAI(newArts, 0, cat, onDone);
    });
  });
}

// --- FETCH ARTICLE TEXT --- (–û—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function fetchArticleText(url, cb) { /* ... */ }

function showErr(msg) { /* ... */ }

// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
restoreSettings();
log("nsumm.ru started", "ok");
testRouter();
// --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è ---
loadTodayArchive();
startGlobalPolling();
</script>
</body>
</html>